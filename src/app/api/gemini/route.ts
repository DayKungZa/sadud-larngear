import { NextResponse } from "next/server";
import { GoogleGenerativeAI } from "@google/generative-ai";

export async function POST(req: Request) {
  try {
    // Validate API Key
    const API_KEY = process.env.NEXT_PUBLIC_GEMINI_API_KEY;
    if (!API_KEY) {
      console.error("Error: Missing API Key");
      return NextResponse.json({ error: "API key missing" }, { status: 500 });
    }

    // Initialize Gemini AI
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({
      model: "gemini-2.0-flash",
      generationConfig: {
        temperature: 0.7, // Controls randomness (0 = deterministic, 1 = more creative)
        topP: 0.95, // Controls diversity (higher = more diverse)
        topK: 50, // Sampling parameter
      }
    });

    //Date
    const now = new Date();
    const formattedDate = now.toISOString().split("T")[0]

    // Get user message
    const { message } = await req.json();
    if (!message) {
      return NextResponse.json({ error: "No message provided" }, { status: 400 });
    }

    // ‚úÖ Custom Horoscope Prompt
    const fullPrompt = `
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏´‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÑ‡∏ó‡∏¢ ‡∏ä‡∏∑‡πà‡∏≠ "‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå" ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏î‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå  
‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ß‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏î‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏™‡∏Å‡πá‡∏ö‡∏≠‡∏Å‡πÑ‡∏õ‡∏ß‡πà‡∏≤‡∏Ñ‡∏¥‡∏î‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô)  
**‡∏≠‡∏¢‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤ ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡πÄ‡∏á‡∏¥‡∏ô,‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡∏î‡∏ß‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ** ‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ  

### üé≠ **‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á**  
‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢ "‡∏ô‡∏∞"  
‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© **‡∏´‡∏£‡∏∑‡∏≠ ()**  
‡∏à‡∏±‡∏î‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô JavaScript  

### ‚öôÔ∏è **‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå**  
- ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö "‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå" ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á A1 - F13) ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡∏î‡∏µ/‡πÑ‡∏°‡πà‡∏î‡∏µ  
- ‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∏‡∏Å‡∏ï‡∏•‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏¢‡πà‡∏≤‡πÑ‡∏õ‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏ï‡∏≠‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ô‡∏∞"  

### üìÖ **‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô**  
‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formattedDate}  
(‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ)  

### üî• **‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•**  
**‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:** ‡∏ú‡∏°‡∏à‡∏∞‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÑ‡∏´‡∏°  
**‡πÇ‡∏´‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå:** ‡πÇ‡∏≠‡πâ‡πÇ‡∏´ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏á‡πà‡∏≤‡∏¢‡∏ô‡∏∞! ‡∏Ç‡∏≠‡∏î‡∏π‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡∏î‡∏µ  

**‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:** ‡∏ú‡∏°‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 8 ‡∏õ‡∏µ 2100 ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡πÑ‡∏´‡∏°  
**‡πÇ‡∏´‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå:** OK! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏£‡∏á‡∏î‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏Å‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå ‡πÑ‡∏õ‡∏•‡∏≠‡∏á A5 ‡∏î‡∏π ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏µ‡πÜ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ô‡∏∞  

**‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:** ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏µ‡πÑ‡∏´‡∏°  
**‡πÇ‡∏´‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå:** ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏û‡∏•‡∏±‡∏á‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏î‡∏ß‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏ô‡∏∞! ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡∏∞‡∏î‡∏∏‡∏î ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ A3 ‡∏´‡∏£‡∏∑‡∏≠ D5 ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏°‡∏µ‡∏Ñ‡∏ô‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏û‡∏¢‡∏∏‡∏á‡∏™‡∏π‡∏á‡∏ô‡∏∞ üòÜ  

**‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:** ‡∏î‡∏π‡∏î‡∏ß‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢  
**‡πÇ‡∏´‡∏£‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå:** ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÜ ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏≠‡∏∞‡πÑ‡∏£‡∏•‡πà‡∏∞ ‡∏ö‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏¥ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡πà‡∏ô‡πÜ ‡∏ô‡∏∞  
  
  ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${message}
    `;

    // Generate AI Response
    const result = await model.generateContent(fullPrompt);

    // ‚úÖ Fix response handling
    const responseText = result.response.text?.() || "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ";

    // ‚úÖ Format text output cleanly
    const formattedText = responseText.replace(/\n/g, "\n\n");

    return NextResponse.json({ reply: formattedText });
  } catch (error: any) {
    console.error("Gemini API Error:", error.message || error);
    return NextResponse.json({ error: "Failed to fetch response from Gemini API" }, { status: 500 });
  }
}
